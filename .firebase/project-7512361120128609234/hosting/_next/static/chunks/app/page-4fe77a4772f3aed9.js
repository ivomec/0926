(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[974],{2751:(e,t,a)=>{Promise.resolve().then(a.bind(a,7674))},7270:(e,t,a)=>{"use strict";a.d(t,{A0:()=>l,BF:()=>d,Hj:()=>c,XI:()=>i,nA:()=>u,nd:()=>o});var r=a(5155),s=a(2115),n=a(4269);let i=s.forwardRef((e,t)=>{let{className:a,...s}=e;return(0,r.jsx)("div",{className:"relative w-full overflow-auto",children:(0,r.jsx)("table",{ref:t,className:(0,n.cn)("w-full caption-bottom text-sm",a),...s})})});i.displayName="Table";let l=s.forwardRef((e,t)=>{let{className:a,...s}=e;return(0,r.jsx)("thead",{ref:t,className:(0,n.cn)("[&_tr]:border-b",a),...s})});l.displayName="TableHeader";let d=s.forwardRef((e,t)=>{let{className:a,...s}=e;return(0,r.jsx)("tbody",{ref:t,className:(0,n.cn)("[&_tr:last-child]:border-0",a),...s})});d.displayName="TableBody",s.forwardRef((e,t)=>{let{className:a,...s}=e;return(0,r.jsx)("tfoot",{ref:t,className:(0,n.cn)("border-t bg-muted/50 font-medium [&>tr]:last:border-b-0",a),...s})}).displayName="TableFooter";let c=s.forwardRef((e,t)=>{let{className:a,...s}=e;return(0,r.jsx)("tr",{ref:t,className:(0,n.cn)("border-b transition-colors hover:bg-muted/50 data-[state=selected]:bg-muted",a),...s})});c.displayName="TableRow";let o=s.forwardRef((e,t)=>{let{className:a,...s}=e;return(0,r.jsx)("th",{ref:t,className:(0,n.cn)("h-12 px-4 text-left align-middle font-medium text-muted-foreground [&:has([role=checkbox])]:pr-0",a),...s})});o.displayName="TableHead";let u=s.forwardRef((e,t)=>{let{className:a,...s}=e;return(0,r.jsx)("td",{ref:t,className:(0,n.cn)("p-4 align-middle [&:has([role=checkbox])]:pr-0",a),...s})});u.displayName="TableCell",s.forwardRef((e,t)=>{let{className:a,...s}=e;return(0,r.jsx)("caption",{ref:t,className:(0,n.cn)("mt-4 text-sm text-muted-foreground",a),...s})}).displayName="TableCaption"},7674:(e,t,a)=>{"use strict";a.r(t),a.d(t,{default:()=>P});var r=a(5155),s=a(2115),n=a(63),i=a(2619),l=a.n(i),d=a(9708),c=a(4585),o=a(3998),u=a(5142),h=a(7270),m=a(8053),x=a(4294);let p=(0,x.A)("ArrowUpDown",[["path",{d:"m21 16-4 4-4-4",key:"f6ql7i"}],["path",{d:"M17 20V4",key:"1ejh1v"}],["path",{d:"m3 8 4-4 4 4",key:"11wl7u"}],["path",{d:"M7 4v16",key:"1glfcx"}]]),g=(0,x.A)("Mic",[["path",{d:"M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z",key:"131961"}],["path",{d:"M19 10v2a7 7 0 0 1-14 0v-2",key:"1vc78b"}],["line",{x1:"12",x2:"12",y1:"19",y2:"22",key:"x3vr5v"}]]);var f=a(2265),j=a(3630),N=a(5894),v=a(6465),y=a(6948),b=a(1218),w=a(1136);let k=e=>{let{sortKey:t,currentSortKey:a,handleSort:s,children:n}=e;return(0,r.jsx)(h.nd,{onClick:()=>s(t),className:"cursor-pointer hover:bg-muted",children:(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[n,a===t&&(0,r.jsx)(p,{className:"h-4 w-4"})]})})};function A(){let[e,t]=(0,s.useState)([]),[a,i]=(0,s.useState)(!0),[x,p]=(0,s.useState)("surgeryDate"),[A,C]=(0,s.useState)("desc"),[D,P]=(0,s.useState)("all"),[S,R]=(0,s.useState)(!1),[M,T]=(0,s.useState)(null),[I,O]=(0,s.useState)(""),[E,_]=(0,s.useState)(""),[Z,$]=(0,s.useState)(!1),[B,H]=(0,s.useState)("버튼을 눌러 AI의 음성 인사를 확인하세요."),[L,J]=(0,s.useState)(!1),{toast:K}=(0,N.dj)(),F=(0,n.useRouter)();(0,s.useEffect)(()=>{i(!0);let e=(0,d.P)((0,d.rJ)(c.db,"patients"),(0,d.My)("updatedAt","desc")),a=(0,d.aQ)(e,e=>{t(e.docs.map(e=>({id:e.id,...e.data()}))),i(!1)},e=>{console.error("Error fetching patients: ",e),K({title:"오류",description:"환자 목록을 불러오는 중 오류가 발생했습니다.",variant:"destructive"}),i(!1)});return()=>a()},[K]);let U=(0,s.useMemo)(()=>Object.values(e.reduce((e,t)=>(t.guardianPhone&&(e[t.guardianPhone]||(e[t.guardianPhone]={guardianName:t.guardianName,guardianPhone:t.guardianPhone,patients:[]}),e[t.guardianPhone].patients.push(t)),e),{})).map(e=>{let t=e.patients.filter(e=>e.name),a=e.patients.map(e=>e.updatedAt).filter(e=>e instanceof d.Dc),r=a.length>0?a.reduce((e,t)=>t.toMillis()>e.toMillis()?t:e):null;if(0===t.length)return{guardianName:e.guardianName,guardianPhone:e.guardianPhone,patients:[],representativeChartId:"반려동물 없음",surgeryDate:null,lastModified:r};let s=[...t].sort((e,t)=>{let a=e.updatedAt instanceof d.Dc?e.updatedAt.toMillis():0;return(t.updatedAt instanceof d.Dc?t.updatedAt.toMillis():0)-a})[0],n=[...t].sort((e,t)=>{let a=e.surgeryDate instanceof d.Dc?e.surgeryDate.toMillis():0;return(t.surgeryDate instanceof d.Dc?t.surgeryDate.toMillis():0)-a})[0];return{guardianName:e.guardianName,guardianPhone:e.guardianPhone,patients:t,representativeChartId:s.id,surgeryDate:(null==n?void 0:n.surgeryDate)instanceof d.Dc?n.surgeryDate:null,lastModified:r}}),[e]),W=(0,s.useCallback)(e=>{x===e?C("asc"===A?"desc":"asc"):(p(e),C("asc"))},[x,A]),G=(0,s.useMemo)(()=>{let e=U;return"all"!==D&&(e=U.filter(e=>e.patients.some(e=>e.species===D))),e.sort((e,t)=>{let a=e[x],r=t[x],s=0;return null==a?s=-1:null==r?s=1:a instanceof d.Dc&&r instanceof d.Dc?s=a.toMillis()-r.toMillis():"string"==typeof a&&"string"==typeof r&&(s=a.localeCompare(r)),"asc"===A?s:-s})},[U,D,x,A]),V=(0,s.useCallback)(async()=>{if(!I||!E)return void K({title:"오류",description:"보호자 이름과 전화번호를 모두 입력해주세요.",variant:"destructive"});if(!/^\d{3}-\d{3,4}-\d{4}$/.test(E))return void K({title:"오류",description:"전화번호 형식이 올바르지 않습니다. (010-1234-5678)",variant:"destructive"});if(U.find(e=>e.guardianPhone===E))return void K({title:"오류",description:"이미 등록된 보호자 전화번호입니다.",variant:"destructive"});$(!0);try{let e=(0,d.H9)((0,d.rJ)(c.db,"patients"));await (0,d.BN)(e,{id:e.id,guardianName:I,guardianPhone:E,createdAt:(0,d.O5)(),updatedAt:(0,d.O5)()}),K({title:"성공",description:"".concat(I," 보호자가 추가되었습니다.")}),O(""),_("")}catch(e){console.error("Error adding new guardian:",e),K({title:"오류",description:"보호자 추가 중 오류가 발생했습니다.",variant:"destructive"})}finally{$(!1)}},[I,E,U,K]),X=(0,s.useCallback)(async()=>{if(M)try{let e=(0,d.wP)(c.db),t=(0,d.P)((0,d.rJ)(c.db,"patients"),(0,d._M)("guardianPhone","==",M.guardianPhone));(await (0,d.GG)(t)).forEach(t=>{e.delete(t.ref)}),await e.commit(),K({title:"성공",description:"".concat(M.guardianName," 보호자 및 모든 반려동물 정보가 삭제되었습니다.")})}catch(e){console.error("Error deleting guardian and patients: ",e),K({title:"오류",description:"보호자 정보 삭제 중 오류가 발생했습니다.",variant:"destructive"})}finally{R(!1),T(null)}},[M,K]),q=(0,s.useCallback)(e=>{let t=encodeURIComponent(e.guardianPhone);F.push("/guardian/".concat(t))},[F]),z=async()=>{J(!0),H("AI가 원장님을 위한 인사말을 생성하고 있어요...");try{let e=await fetch("/api/ai-greeting",{method:"POST"});if(!e.ok){let t="서버 응답을 확인하지 못했습니다.";try{let a=await e.json();t=a.error||a.details||JSON.stringify(a)}catch(a){t=e.statusText}throw Error("AI 인사말을 가져오는데 실패했습니다: ".concat(t))}let t=(await e.json()).message;H(t);let a=await fetch("/api/tts",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({text:t})});if(!a.ok){let e="서버로부터 상세 오류를 받지 못했습니다.";try{let t=await a.json();e=t.details||JSON.stringify(t)}catch(t){e=a.statusText}throw Error("TTS 오디오 생성 실패: ".concat(e))}let r=await a.blob(),s=URL.createObjectURL(r);new Audio(s).play()}catch(e){console.error("AI 연결 테스트 중 오류:",e),H("오류 발생: ".concat(e.message)),K({title:"AI 연결 테스트 오류",description:e.message,variant:"destructive"})}finally{J(!1)}};return a?(0,r.jsx)(v.p,{text:"목록을 불러오는 중..."}):(0,r.jsxs)("div",{className:"space-y-6",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("h1",{className:"text-3xl font-bold tracking-tight",children:"대시보드"}),(0,r.jsx)("p",{className:"text-muted-foreground",children:"보호자를 선택하거나 새로 추가하세요."})]}),(0,r.jsxs)(y.Zp,{children:[(0,r.jsx)(y.aR,{children:(0,r.jsx)(y.ZB,{children:"AI 비서"})}),(0,r.jsxs)(y.Wu,{className:"space-y-4",children:[(0,r.jsx)("div",{className:"flex items-center gap-4",children:(0,r.jsxs)(o.$,{onClick:z,disabled:L,children:[(0,r.jsx)(g,{className:"mr-2 h-4 w-4"}),L?"음성 생성 중...":"AI 음성 인사"]})}),(0,r.jsx)("p",{className:"text-sm text-muted-foreground italic",children:B})]})]}),(0,r.jsxs)(y.Zp,{children:[(0,r.jsx)(y.aR,{children:(0,r.jsx)(y.ZB,{children:"새 보호자 추가"})}),(0,r.jsx)(y.Wu,{children:(0,r.jsxs)("div",{className:"flex items-center gap-4",children:[(0,r.jsx)(u.p,{placeholder:"보호자 이름",value:I,onChange:e=>O(e.target.value),className:"max-w-xs"}),(0,r.jsx)(u.p,{placeholder:"전화번호",value:E,onChange:e=>{let t=e.target.value.replace(/[^0-9]/g,""),a="";t.length>3?(a+=t.substring(0,3)+"-",t.length>7?(a+=t.substring(3,7)+"-",a+=t.substring(7,11)):a+=t.substring(3)):a=t,_(a)},className:"max-w-xs",maxLength:13}),(0,r.jsxs)(o.$,{onClick:V,disabled:Z,children:[(0,r.jsx)(f.A,{className:"mr-2 h-4 w-4"}),Z?"추가 중...":"추가"]})]})})]}),(0,r.jsxs)(y.Zp,{children:[(0,r.jsxs)(y.aR,{className:"flex-row items-center justify-between",children:[(0,r.jsx)(y.ZB,{children:"보호자 목록"}),(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsx)(o.$,{variant:"all"===D?"default":"outline",onClick:()=>P("all"),children:"전체"}),(0,r.jsxs)(o.$,{variant:"개"===D?"default":"outline",onClick:()=>P("개"),children:[(0,r.jsx)(b.w,{className:"mr-2 h-4 w-4"}),"강아지"]}),(0,r.jsxs)(o.$,{variant:"고양이"===D?"default":"outline",onClick:()=>P("고양이"),children:[(0,r.jsx)(w.k,{className:"mr-2 h-4 w-4"}),"고양이"]})]})]}),(0,r.jsx)(y.Wu,{children:(0,r.jsx)("div",{className:"border rounded-lg",children:(0,r.jsxs)(h.XI,{children:[(0,r.jsx)(h.A0,{children:(0,r.jsxs)(h.Hj,{children:[(0,r.jsx)(k,{sortKey:"guardianName",currentSortKey:x,handleSort:W,children:"보호자 이름"}),(0,r.jsx)(h.nd,{children:"전화번호"}),(0,r.jsx)(h.nd,{children:"반려동물"}),(0,r.jsx)(h.nd,{children:"대표 차트번호"}),(0,r.jsx)(k,{sortKey:"surgeryDate",currentSortKey:x,handleSort:W,children:"수술일"}),(0,r.jsx)(h.nd,{children:"작업"})]})}),(0,r.jsx)(h.BF,{children:G.length>0?G.map(e=>(0,r.jsxs)(h.Hj,{onClick:()=>q(e),className:"cursor-pointer",children:[(0,r.jsx)(h.nA,{className:"font-medium",children:e.guardianName}),(0,r.jsx)(h.nA,{className:"text-muted-foreground",children:e.guardianPhone}),(0,r.jsx)(h.nA,{children:(0,r.jsx)("div",{className:"flex flex-wrap gap-x-2 gap-y-1 items-center",children:e.patients.length>0?e.patients.map((t,a)=>(0,r.jsxs)(l(),{href:"/patient/".concat(t.id),className:"hover:underline text-primary",onClick:e=>e.stopPropagation(),children:[t.name,a<e.patients.length-1?",":""]},t.id)):(0,r.jsx)("span",{className:"text-muted-foreground text-xs",children:"반려동물 없음"})})}),(0,r.jsx)(h.nA,{className:"font-mono text-xs",children:e.representativeChartId}),(0,r.jsx)(h.nA,{children:function(e){if(!e)return"N/A";let t=e instanceof d.Dc?e.toDate():e;return!(t instanceof Date)||isNaN(t.getTime())?"Invalid Date":new Intl.DateTimeFormat("ko-KR",{year:"numeric",month:"2-digit",day:"2-digit"}).format(t).replace(/\. /g,"-").replace(".","")}(e.surgeryDate)}),(0,r.jsx)(h.nA,{children:(0,r.jsxs)(o.$,{variant:"ghost",size:"icon",className:"h-8 w-8 text-destructive hover:text-destructive",onClick:t=>{t.stopPropagation(),T(e),R(!0)},children:[(0,r.jsx)(j.A,{className:"h-4 w-4"}),(0,r.jsx)("span",{className:"sr-only",children:"삭제"})]})})]},e.guardianPhone)):(0,r.jsx)(h.Hj,{children:(0,r.jsx)(h.nA,{colSpan:6,className:"h-24 text-center",children:"all"===D?"등록된 보호자가 없습니다.":"등록된 ".concat(D," 보호자가 없습니다.")})})})]})})})]}),(0,r.jsx)(m.Lt,{open:S,onOpenChange:R,children:(0,r.jsxs)(m.EO,{children:[(0,r.jsxs)(m.wd,{children:[(0,r.jsx)(m.r7,{children:"정말로 삭제하시겠습니까?"}),(0,r.jsxs)(m.$v,{children:["이 작업은 되돌릴 수 없습니다. ",null==M?void 0:M.guardianName," 보호자의 모든 반려동물 정보가 영구적으로 삭제됩니다."]})]}),(0,r.jsxs)(m.ck,{children:[(0,r.jsx)(m.Zr,{children:"취소"}),(0,r.jsx)(m.Rx,{onClick:X,className:"bg-destructive hover:bg-destructive/90",children:"삭제"})]})]})})]})}var C=a(2641),D=a(9017);function P(){let[e,t]=(0,s.useState)(!1);return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(D.Y,{isLoggedIn:e,onLogout:()=>{t(!1)}}),(0,r.jsx)("div",{className:"container mx-auto p-4 md:p-6 bg-background",children:e?(0,r.jsx)(A,{}):(0,r.jsx)(C.A,{onLoginSuccess:()=>{t(!0)}})})]})}}},e=>{e.O(0,[992,138,45,619,279,429,441,255,358],()=>e(e.s=2751)),_N_E=e.O()}]);